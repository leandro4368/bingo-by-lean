<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Panel Admin — Notificaciones</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
body { background:#060d18; color:white; font-family:Arial, sans-serif; padding:18px; }
.containerBox{ background: rgba(255,255,255,0.07); padding:16px; border-radius:10px; margin-bottom:16px; border:1px solid rgba(255,255,255,0.12); }
h2{ margin-bottom:12px; color:#ffc107; text-shadow:0 0 8px rgba(255,193,7,0.15); }
.notif { background: rgba(0,0,0,0.45); padding:10px; border-radius:8px; margin-bottom:8px; display:flex; gap:8px; align-items:center; justify-content:space-between; }
.badgeTipo { min-width:86px; text-align:center; font-weight:bold; }
.btnSmall { padding:4px 8px; font-size:13px; }
</style>
</head>

<body>

<h2>Panel Admin — Notificaciones</h2>

<div class="row">
  <div class="col-md-6">
    <div class="containerBox">
      <h5>Últimos números</h5>
      <div id="numerosAnim" style="display:flex; gap:12px; margin-top:10px;"></div>
      <div class="mt-3">
        <button class="btn btn-sm btn-primary" onclick="limpiarNotifs()">Limpiar notificaciones vistas</button>
      </div>
    </div>

    <div class="containerBox">
      <h5>Notificaciones entrantes</h5>
      <div id="notifsList"></div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="containerBox">
      <h5>Control Sorteo</h5>
      <div id="numeroActual" style="font-size:48px; font-weight:bold; color:#ffc107;">--</div>
      <div class="mt-2">
        <button class="btn btn-success btn-sm" onclick="sacarNumero()">Sacar número</button>
        <button class="btn btn-warning btn-sm" onclick="reiniciarSorteo()">Reiniciar</button>
      </div>
    </div>

    <div class="containerBox">
      <h5>Jugadores con cartones</h5>
      <div id="conCartones"></div>
    </div>
  </div>
</div>


<!-- =============================================================
     JUGADORES EN ESPERA
============================================================= -->
<div class="col-md-12 mt-4">
    <div class="containerBox">
        <h5>Jugadores en espera</h5>
        <div id="jugadoresEspera"></div>
    </div>
</div>

<!-- =============================================================
     NUEVO PANEL: ASIGNAR CARTONES
============================================================= -->
<div class="col-md-12 mt-4">
    <div class="containerBox">
        <h5>Asignar cartones a jugadores aceptados</h5>
        <div id="aceptadosSinCartones"></div>
    </div>
</div>


<script>
/* ============================================================================
   CARGAR JUGADORES EN ESPERA (solo NO aceptados)
============================================================================ */
function cargarJugadoresEnEspera() {
    const box = document.getElementById("jugadoresEspera");
    if (!box) return;
    box.innerHTML = "";

    Object.keys(localStorage).forEach(k => {
        if (!k.startsWith("player_")) return;
        const p = JSON.parse(localStorage.getItem(k) || "{}");

        // Solo mostrar NO aceptados
        if (p.aceptado !== true) {

            const div = document.createElement("div");
            div.className = "p-3 mb-2 bg-dark rounded border border-secondary";

            div.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <strong style="font-size:18px">${p.nombre}</strong>
                        <div style="font-size:12px;color:#bbb;">En espera</div>
                    </div>

                    <div class="col-md-3">
                        <input type="number" min="1" max="6" id="cant_${k}" 
                               class="form-control form-control-sm"
                               placeholder="Cartones">
                    </div>

                    <div class="col-md-5 text-end">
                        <button class="btn btn-success btn-sm"
                                onclick="aceptarJugador('${k}')">
                            Aceptar
                        </button>
                    </div>
                </div>
            `;

            box.appendChild(div);
        }
    });
}


/* ============================================================================
   ACEPTAR JUGADOR
============================================================================ */
function aceptarJugador(key) {
    const p = JSON.parse(localStorage.getItem(key) || "{}");

    p.aceptado = true;
    p.asignado = false;
    p.cartonesRender = null;

    localStorage.setItem(key, JSON.stringify(p));
}


/* ============================================================================
   GENERAR CARTÓN CLÁSICO (90 bolillas)
============================================================================ */
function generarCartonClasico() {
    const carton = [[], [], []];

    for (let col = 0; col < 9; col++) {
        const min = col * 10 + 1;
        const max = col === 8 ? 90 : col * 10 + 10;

        const nums = [];
        while (nums.length < 3) {
            const n = Math.floor(Math.random() * (max - min + 1)) + min;
            if (!nums.includes(n)) nums.push(n);
        }
        nums.sort((a,b)=>a-b);
        for (let f=0; f<3; f++) carton[f][col] = nums[f];
    }

    // 4 casilleros vacíos por fila
    for (let f=0; f<3; f++){
        const idx = [0,1,2,3,4,5,6,7,8].sort(()=>Math.random()-0.5).slice(0,4);
        idx.forEach(i => carton[f][i] = null);
    }

    return carton;
}


/* ============================================================================
   PANEL NUEVO → ACEPTADOS SIN CARTONES
============================================================================ */
function cargarAceptadosSinCartones() {
    const box = document.getElementById("aceptadosSinCartones");
    if (!box) return;

    box.innerHTML = "";

    Object.keys(localStorage).forEach(k => {
        if (!k.startsWith("player_")) return;
        const p = JSON.parse(localStorage.getItem(k) || "{}");

        if (p.aceptado === true && (!p.cartonesRender || p.asignado === false)) {

            const div = document.createElement("div");
            div.className = "p-3 mb-2 bg-dark rounded border border-secondary";

            div.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <strong style="font-size:18px">${p.nombre}</strong>
                        <div style="font-size:12px;color:#bbb;">Aceptado — Sin cartones</div>
                    </div>

                    <div class="col-md-3">
                        <input type="number" min="1" max="6" id="asig_${k}"
                               class="form-control form-control-sm"
                               placeholder="Cartones">
                    </div>

                    <div class="col-md-4 text-end">
                        <button class="btn btn-primary btn-sm"
                            onclick="asignarCartones('${k}', true)">
                            Asignar cartones
                        </button>
                    </div>
                </div>
            `;

            box.appendChild(div);
        }
    });
}


/* ============================================================================
   ASIGNAR CARTONES
============================================================================ */
function asignarCartones(key, desdePanel = false) {
    const p = JSON.parse(localStorage.getItem(key) || "{}");

    if (!p.aceptado) {
        alert("Primero debes aceptar al jugador.");
        return;
    }

    const inputID = desdePanel ? "asig_" + key : "cant_" + key;
    const cant = parseInt(document.getElementById(inputID).value);

    if (!cant || cant < 1 || cant > 6) {
        alert("Cantidad inválida (1 a 6).");
        return;
    }

    const lista = [];
    for (let i = 0; i < cant; i++) {
        lista.push(generarCartonClasico());
    }

    p.asignado = true;
    p.cartonesRender = lista;

    localStorage.setItem(key, JSON.stringify(p));

    cargarJugadoresEnEspera();
    cargarAceptadosSinCartones();
    cargarConCartones();

    alert("Cartones asignados correctamente.");
}


/* ============================================================================
   JUGADORES CON CARTONES
============================================================================ */
function cargarConCartones() {
    const cont = document.getElementById("conCartones");
    cont.innerHTML = "";

    Object.keys(localStorage).forEach(k => {
        if (!k.startsWith("player_")) return;
        const p = JSON.parse(localStorage.getItem(k) || "{}");

        if (p.asignado && p.cartonesRender) {
            const d = document.createElement("div");
            d.style.padding = "6px 8px";
            d.style.borderBottom = "1px solid rgba(255,255,255,0.03)";
            d.innerHTML = `<strong>${p.nombre}</strong> — ${p.cartonesRender.length} cartón(es)`;
            cont.appendChild(d);
        }
    });
}


/* ============================================================================
   REFRESH AUTOMÁTICO
============================================================================ */
setInterval(() => {

    // No refrescar si el admin está escribiendo dentro de un input
    const activo = document.activeElement;
    if (activo && activo.tagName === "INPUT") {
        return; // evita borrar lo que se está escribiendo
    }

    cargarJugadoresEnEspera();
    cargarAceptadosSinCartones();
    cargarConCartones();

}, 1200);


cargarJugadoresEnEspera();
cargarAceptadosSinCartones();
cargarConCartones();

</script>




<!-- ====================================================================================
     NOTIFICACIONES + SORTEO (SE MANTIENE TAL CUAL — NO SE MODIFICÓ NADA)
==================================================================================== -->
<script>
function idEl(id){ return document.getElementById(id); }
function leerNotifs(){ try { return JSON.parse(localStorage.getItem("notificaciones")||"[]"); } catch(e){ return []; } }
function escribirNotifs(a){ localStorage.setItem("notificaciones", JSON.stringify(a)); }

function actualizarUltimosTresAdmin(arr) {
    const cont = idEl("numerosAnim");
    [...cont.children].forEach(c=>{ c.classList.add("fadeOut"); setTimeout(()=>c.remove(),300); });
    const ult = arr.slice(-3);
    setTimeout(()=>{
        ult.forEach(num=>{
            const d = document.createElement("div");
            d.textContent = num;
            d.style.fontSize = "36px";
            d.style.color = "#ffc107";
            d.style.opacity = "0";
            d.style.transform = "scale(.5)";
            d.style.transition = "all .35s";
            cont.appendChild(d);
            setTimeout(()=>{ d.style.opacity = "1"; d.style.transform = "scale(1)"; },60);
        });
    },350);
}

function renderNotifs() {
    const list = idEl("notifsList");
    list.innerHTML = "";
    const arr = leerNotifs().slice().reverse();

    arr.forEach(n=>{
        const div = document.createElement("div");
        div.className = "notif";

        const left = document.createElement("div");
        left.innerHTML = `<div style="font-weight:bold">${n.mensaje}</div>
                          <div style="font-size:12px;color:#ccc">${new Date(n.ts).toLocaleTimeString()}</div>`;

        const right = document.createElement("div");
        
        const tipo = document.createElement("span");
        tipo.className = "badge bg-warning text-dark badgeTipo";
        tipo.textContent = n.tipo;

        const btn = document.createElement("button");
        btn.className = "btn btn-sm btn-light btnSmall";
        btn.textContent = "Aceptar";
        btn.onclick = ()=> aceptarNotif(n.id);

        right.appendChild(tipo);
        right.appendChild(btn);

        div.appendChild(left);
        div.appendChild(right);

        list.appendChild(div);
    });

    const arrNums = JSON.parse(localStorage.getItem("numerosSorteados")||"[]");
    idEl("numeroActual").textContent = arrNums.length? arrNums.slice(-1)[0] : "--";
}

function aceptarNotif(id) {
    const arr = leerNotifs();
    const idx = arr.findIndex(x=>x.id===id);
    if (idx === -1) return;
    arr[idx].visto = true;
    escribirNotifs(arr);
    renderNotifs();
}

function limpiarNotifs(){
    let arr = leerNotifs();
    arr = arr.filter(n => !n.visto);
    escribirNotifs(arr);
    renderNotifs();
}

window.addEventListener('storage', (e)=>{
    if (e.key === "notificaciones" || e.key === "numerosSorteados") {
        const arr = JSON.parse(localStorage.getItem("numerosSorteados")||"[]");
        if (arr.length) actualizarUltimosTresAdmin(arr);
        renderNotifs();
    }
});

(function init(){
    const arrNums = JSON.parse(localStorage.getItem("numerosSorteados")||"[]");
    if (arrNums.length) actualizarUltimosTresAdmin(arrNums);
    renderNotifs();
})();

/* ============================================================
   FUNCIONES FALTANTES: SACAR NÚMERO + REINICIAR
============================================================ */

// Obtener lista completa del 1 al 90
function getBolillero() {
    const arr = [];
    for (let i = 1; i <= 90; i++) arr.push(i);
    return arr;
}

function sacarNumero(){
    let arr = JSON.parse(localStorage.getItem("numerosSorteados") || "[]");

    if (arr.length >= 90) { 
        alert("Ya salieron todos los números.");
        return; 
    }

    let n;
    do {
        n = Math.floor(Math.random() * 90) + 1;
    } while (arr.includes(n));

    arr.push(n);

    localStorage.setItem("numerosSorteados", JSON.stringify(arr));
    localStorage.setItem("ultimoNumero", n);

    document.getElementById("numeroActual").textContent = n;

    actualizarUltimosTresAdmin(arr);
}


function reiniciarSorteo() {
    if (!confirm("¿Reiniciar el sorteo? Se borrarán todos los números.")) return;

    localStorage.removeItem("numerosSorteados");
    localStorage.removeItem("ultimoNumero");

    document.getElementById("numeroActual").textContent = "--";
    actualizarUltimosTresAdmin([]);
}

</script>

</body>
</html>
